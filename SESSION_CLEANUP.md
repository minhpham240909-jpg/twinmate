# Study Session Cleanup & Finalization

## Overview

Comprehensive session lifecycle management with proper cleanup, data persistence, and automated maintenance.

## Session Lifecycle

```
SCHEDULED → IN_PROGRESS → COMPLETED
     ↓            ↓            ↓
  (cleanup)  (auto-end)   (archived)
```

## Manual Session End

### Endpoint: `POST /api/study-sessions/[sessionId]/end`

**Features:**
- ✅ Rate limited (20 requests/minute)
- ✅ Host-only authorization
- ✅ Atomic transaction for data integrity
- ✅ Automatic participant cleanup
- ✅ Session summary generation
- ✅ Notifications to all participants
- ✅ Duration calculation and tracking

**Process:**
1. Validates user is session host
2. Checks session is in valid state (IN_PROGRESS)
3. Collects session statistics (participants, notes, flashcards, messages)
4. Performs atomic transaction:
   - Updates session status to COMPLETED
   - Sets endedAt timestamp and calculates duration
   - Updates all participants to LEFT status
   - Creates session summary record
   - Sends notifications to participants
5. Returns summary data

**Usage:**
```typescript
const response = await fetch(`/api/study-sessions/${sessionId}/end`, {
  method: 'POST',
})

const data = await response.json()
// {
//   success: true,
//   session: { id, status, endedAt, durationMinutes },
//   summary: { participants, notes, flashcards, messages }
// }
```

## Automated Cleanup

### Endpoint: `POST /api/study-sessions/cleanup`

**Protected by:**
- Vercel Cron authentication header
- OR API key authentication (`X-API-Key` header)

**Cleanup Rules:**

1. **Delete Inactive SCHEDULED Sessions**
   - Sessions older than 30 minutes
   - No timer started (totalStudyTime = 0)
   - Never actually used

2. **Auto-End Abandoned IN_PROGRESS Sessions**
   - Sessions older than 6 hours
   - Likely forgotten/abandoned
   - Automatically ends with proper cleanup
   - Updates participants to LEFT status

**Schedule:**
Run via Vercel Cron (recommended) or manual trigger.

### Setting Up Cron Job

Create `vercel.json` in project root:

```json
{
  "crons": [{
    "path": "/api/study-sessions/cleanup",
    "schedule": "0 */2 * * *"
  }]
}
```

This runs cleanup every 2 hours.

## Environment Variables

Add to `.env.local` and production:

```bash
# Vercel Cron Secret (auto-generated by Vercel)
CRON_SECRET=your-cron-secret

# Optional: Manual cleanup API key
CLEANUP_API_KEY=your-cleanup-api-key
```

## Session Data Persistence

### What Gets Saved

**Always Persisted:**
- Session metadata (title, subject, description)
- Start/end timestamps and duration
- All notes created during session
- All flashcards created during session
- All messages sent during session
- Participant join/leave records
- Timer records (total study time, breaks)
- Session goals and completion status

**Summary Analytics:**
- Participant count
- Notes/flashcards/messages counts
- Who ended the session
- Total duration

### What Gets Cleaned Up

**On Session End:**
- Active participant connections (status → LEFT)
- Real-time presence indicators
- Temporary whiteboard state (unless explicitly saved)

**On Automated Cleanup:**
- SCHEDULED sessions with no activity (fully deleted)
- IN_PROGRESS sessions auto-ended after 6 hours

## Notifications

### Session End Notifications

All participants (except host) receive notification:
- **Type:** SESSION_ENDED
- **Title:** "Study Session Ended"
- **Message:** Includes session name and duration
- **Action:** Link to session summary page

## Data Integrity

### Transaction Guarantees

All session end operations use Prisma transactions:
- Either all operations succeed, or none do
- No partial state changes
- Maintains database consistency

### Error Handling

- Session summary creation fails gracefully (optional data)
- Notification failures logged but don't block main operation
- Auto-cleanup continues even if individual sessions fail

## Testing

### Test Manual End

```bash
# End a session
curl -X POST http://localhost:3000/api/study-sessions/SESSION_ID/end \
  -H "Cookie: your-auth-cookie"
```

### Test Automated Cleanup

```bash
# With API key
curl -X POST http://localhost:3000/api/study-sessions/cleanup \
  -H "X-API-Key: your-cleanup-api-key"

# Or with Vercel Cron secret
curl -X POST http://localhost:3000/api/study-sessions/cleanup \
  -H "Authorization: Bearer your-cron-secret"
```

## Monitoring

### Metrics to Track

1. **Session Duration:**
   - Average session length
   - Distribution of session durations
   - Abandoned session rate

2. **Cleanup Efficiency:**
   - Inactive sessions deleted per run
   - Abandoned sessions auto-ended per run
   - Cleanup execution time

3. **User Engagement:**
   - Notes/flashcards created per session
   - Messages sent per session
   - Participant count per session

### Logs to Monitor

```typescript
// Successful cleanup
console.log('Cleaned up X inactive session(s) and auto-ended Y abandoned session(s)')

// Failed auto-end
console.error('Failed to auto-end session SESSION_ID:', error)

// Failed notifications
console.error('Failed to create end notifications:', error)
```

## Best Practices

### For Hosts

1. **Always end sessions manually** when done
2. Don't rely on auto-cleanup for normal operation
3. Review session summary before closing
4. Ensure important data is saved (notes, flashcards)

### For Developers

1. **Use transactions** for all multi-step operations
2. **Fail gracefully** on non-critical operations
3. **Log errors** but don't expose to users
4. **Test cleanup** regularly in staging
5. **Monitor cleanup metrics** in production

## Troubleshooting

### Session Won't End

**Symptoms:** End button doesn't work, session stays IN_PROGRESS

**Solutions:**
1. Check user is session host
2. Verify session has been started
3. Check for database connection issues
4. Look for transaction errors in logs

### Cleanup Not Running

**Symptoms:** Old sessions accumulate, no cleanup logs

**Solutions:**
1. Verify Vercel Cron is configured
2. Check CRON_SECRET is set correctly
3. Manually trigger cleanup with API key
4. Check Vercel deployment logs

### Missing Session Data

**Symptoms:** Notes/flashcards not saved after session

**Solutions:**
1. Ensure session was properly ended (not auto-cleaned)
2. Check transaction logs for failures
3. Verify cascade delete rules in schema
4. Look for data before session was deleted

## Future Enhancements

### Potential Improvements

1. **Session Archives:**
   - Keep completed sessions for X days
   - Allow participants to download session data
   - Export to PDF/markdown

2. **Smart Cleanup:**
   - Machine learning to detect truly abandoned sessions
   - Different thresholds based on session type
   - Warning notifications before auto-end

3. **Recovery:**
   - Undo session end (within 5 minutes)
   - Recover accidentally deleted sessions
   - Session state snapshots

4. **Analytics:**
   - Detailed session performance metrics
   - Participant engagement scores
   - Study effectiveness tracking

## Database Schema

### SessionSummary Model (Optional)

If you want detailed analytics, add this model to Prisma schema:

```prisma
model SessionSummary {
  id                String   @id @default(cuid())
  sessionId         String   @unique
  session           StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  durationMinutes   Int
  participantCount  Int
  notesCount        Int
  flashcardsCount   Int
  messagesCount     Int
  endedBy           String
  endedByUser       User     @relation(fields: [endedBy], references: [id])
  createdAt         DateTime @default(now())
}
```

## API Reference

### End Session

```typescript
POST /api/study-sessions/[sessionId]/end

Rate Limit: 20/minute
Auth: Required (Host only)

Response: {
  success: boolean
  session: {
    id: string
    status: 'COMPLETED'
    endedAt: Date
    durationMinutes: number
  }
  summary: {
    participants: number
    notes: number
    flashcards: number
    messages: number
  }
}
```

### Cleanup Sessions

```typescript
POST /api/study-sessions/cleanup

Auth: Vercel Cron OR API Key
Headers:
  - Authorization: Bearer {CRON_SECRET}
  - OR X-API-Key: {CLEANUP_API_KEY}

Response: {
  success: boolean
  deletedCount: number
  autoEndedCount: number
  message: string
}
```

## Summary

✅ **Implemented:**
- Manual session end with full cleanup
- Automated cleanup for inactive/abandoned sessions
- Transaction-based data integrity
- Notification system for participants
- Rate limiting and security
- Comprehensive error handling

⚠️ **TODO:**
- Set up Vercel Cron job
- Add SessionSummary model (optional)
- Configure monitoring/alerts
- Test in production environment

The session cleanup system ensures data integrity, prevents resource leaks, and provides a smooth user experience for ending study sessions.
