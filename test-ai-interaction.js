/**
 * Test AI Agent Interaction - Simulate what happens when user asks for partners
 * This helps identify if the AI is calling the tool or not
 */

require('dotenv').config({ path: '.env.local' })

async function testAIInteraction() {
  console.log('=' .repeat(80))
  console.log('🤖 AI AGENT INTERACTION TEST')
  console.log('=' .repeat(80))
  console.log('')
  console.log('This test simulates what happens when you ask the AI:')
  console.log('"Find me a study partner"')
  console.log('')
  console.log('=' .repeat(80))
  console.log('')

  // Check if server is running
  console.log('STEP 1: Check if development server is running')
  console.log('-'.repeat(80))
  
  try {
    const response = await fetch('http://localhost:3000/api/ai-agent/chat', {
      method: 'GET'
    })
    
    if (response.ok) {
      const data = await response.json()
      console.log('✅ AI Agent API is responding')
      console.log('   Status:', data.status)
      console.log('   Version:', data.version)
      console.log('   Tools Available:', data.toolsAvailable)
    } else {
      console.log('⚠️  API responded with status:', response.status)
    }
  } catch (error) {
    console.log('❌ Cannot connect to development server')
    console.log('   Error:', error.message)
    console.log('')
    console.log('📌 TO USE THIS TEST:')
    console.log('   1. Open a terminal and run: npm run dev')
    console.log('   2. Wait for server to start (should see "Ready on http://localhost:3000")')
    console.log('   3. Then run this test again: node test-ai-interaction.js')
    console.log('')
    console.log('=' .repeat(80))
    console.log('')
    console.log('ALTERNATIVE: Test the tool directly without server')
    console.log('-'.repeat(80))
    console.log('')
    console.log('The comprehensive diagnosis shows everything is working:')
    console.log('✅ Database: 4 users, 3 potential partners')
    console.log('✅ Tool: matchCandidates returns 3 matches (88.6%, 33.3%, 30.7%)')
    console.log('✅ Prompt: Has RULE 5 for partner matching')
    console.log('✅ API: Properly configured')
    console.log('')
    console.log('🔍 THE ISSUE IS LIKELY:')
    console.log('')
    console.log('Since everything works in testing, the problem might be:')
    console.log('')
    console.log('1. ⚠️  AI NOT CALLING THE TOOL')
    console.log('   The AI receives your message but decides not to call matchCandidates')
    console.log('   ')
    console.log('   WHY: Even with RULE 5, the AI might not recognize your query')
    console.log('   ')
    console.log('   TEST: Try these exact phrases:')
    console.log('   - "find me a study partner"')
    console.log('   - "looking for study buddy"')
    console.log('   - "who can I study with"')
    console.log('')
    console.log('2. ⚠️  CONVERSATION HISTORY INTERFERENCE')
    console.log('   If you asked before and AI said "no partners", it might remember')
    console.log('   ')
    console.log('   FIX: Start a NEW chat session (clear history)')
    console.log('')
    console.log('3. ⚠️  PRODUCTION VS DEVELOPMENT')
    console.log('   If using production (Vercel), it might have old code')
    console.log('   ')
    console.log('   FIX: Redeploy to production')
    console.log('')
    console.log('4. ⚠️  TOOL EXECUTION ERROR (Silent Failure)')
    console.log('   Tool is called but throws error that AI doesn\'t show you')
    console.log('   ')
    console.log('   CHECK: Server console logs for errors')
    console.log('')
    console.log('=' .repeat(80))
    console.log('')
    console.log('📋 DEBUGGING CHECKLIST:')
    console.log('')
    console.log('When you ask "find me a study partner", check:')
    console.log('')
    console.log('□ Server logs show: [matchCandidates] Profile: ...')
    console.log('  → If YES: Tool is being called ✓')
    console.log('  → If NO: AI is not calling the tool ✗')
    console.log('')
    console.log('□ Server logs show: [matchCandidates] Candidates found: 3')
    console.log('  → If YES: Tool found candidates ✓')
    console.log('  → If NO: Database issue ✗')
    console.log('')
    console.log('□ Server logs show: [matchCandidates] RETURN: 3 matches')
    console.log('  → If YES: Tool returned results ✓')
    console.log('  → If NO: Filtering removed all matches ✗')
    console.log('')
    console.log('□ AI response mentions the matches')
    console.log('  → If YES: Everything works! ✓')
    console.log('  → If NO: AI ignored tool output ✗')
    console.log('')
    console.log('=' .repeat(80))
    return
  }

  console.log('')
  console.log('STEP 2: Test actual AI query')
  console.log('-'.repeat(80))
  console.log('')
  console.log('⚠️  NOTE: This requires authentication')
  console.log('You need to be logged in to use the AI agent API')
  console.log('')
  console.log('Instead, use the web interface:')
  console.log('1. Open http://localhost:3000 in your browser')
  console.log('2. Log in to your account')
  console.log('3. Go to AI Agent chat')
  console.log('4. Type: "find me a study partner"')
  console.log('5. Watch the server console for [matchCandidates] logs')
  console.log('')
  console.log('=' .repeat(80))
}

testAIInteraction().catch(error => {
  console.error('Test failed:', error)
})
